/**
 * Akim Farrow website commission intake
 * HTML form / fetch -> Google Apps Script Web App -> Google Sheet rows + email notify
 *
 * KEY FIXES
 * - Uses SpreadsheetApp.openById(SPREADSHEET_ID) (NOT getActiveSpreadsheet)
 * - Handles both form-encoded POSTs and JSON POSTs
 * - Sends formatted HTML email that matches the page styling (inline styles)
 * - Adds doGet() health check
 * - Adds LockService to prevent row collisions under simultaneous submits
 */

const SPREADSHEET_ID = "PASTE_YOUR_SHEET_ID_HERE"; // <-- REQUIRED
const SHEET_NAME = "requests";
const NOTIFY_TO = "akimfarrowstudio@gmail.com";

function doGet() {
  return ContentService
    .createTextOutput(JSON.stringify({ ok: true, sheet: SHEET_NAME }))
    .setMimeType(ContentService.MimeType.JSON);
}

function doPost(e) {
  try {
    const data = getPayload_(e); // handles form params and JSON body

    // Honeypot spam block
    if (data.website && String(data.website).trim() !== "") {
      return text_("blocked");
    }

    const name = (data.name || "").trim();
    const email = (data.email || "").trim();
    if (!name || !email) {
      return text_("missing required fields");
    }

    const lock = LockService.getScriptLock();
    lock.waitLock(15000);

    try {
      const sheet = getSheet_();
      setupSheet_(sheet);

      const row = [
        new Date(),
        name,
        email,
        (data.phone || "").trim(),
        (data.timeline || "").trim(),
        (data.scope || "").trim(),
        (data.location || "").trim(),
        (data.budget || "").trim(),
        (data.materials || "").trim(),
        (data.specs || "").trim(),
        (data.links || "").trim(),
        (data.page || "").trim(),
        (data.userAgent || "").trim()
      ];

      sheet.appendRow(row);
    } finally {
      lock.releaseLock();
    }

    // Email: do not break submission if email fails
    try {
      MailApp.sendEmail({
        to: NOTIFY_TO,
        replyTo: email,
        subject: `New Commission Request: ${name}`,
        htmlBody: buildEmailHtml_(data, name, email)
      });
    } catch (mailErr) {
      console.error("EMAIL_FAILED", mailErr && mailErr.message ? mailErr.message : mailErr);
    }

    return text_("ok");
  } catch (err) {
    console.error("DOPOST_FAILED", err && err.message ? err.message : err);
    return text_("error");
  }
}

/**
 * Robust payload parsing:
 * - HTML form submit: e.parameter
 * - fetch JSON: e.postData.contents (application/json)
 */
function getPayload_(e) {
  const base = (e && e.parameter) ? Object.assign({}, e.parameter) : {};

  // If JSON body exists, merge it (JSON wins)
  try {
    const ct = e && e.postData && e.postData.type ? String(e.postData.type) : "";
    const body = e && e.postData && e.postData.contents ? String(e.postData.contents) : "";

    if (body && ct.indexOf("application/json") !== -1) {
      const parsed = JSON.parse(body);
      if (parsed && typeof parsed === "object") {
        Object.keys(parsed).forEach(k => { base[k] = parsed[k]; });
      }
    }
  } catch (_) {}

  return base;
}

function getSheet_() {
  const ss = SpreadsheetApp.openById(SPREADSHEET_ID);
  const sheet = ss.getSheetByName(SHEET_NAME) || ss.insertSheet(SHEET_NAME);
  return sheet;
}

function setupSheet_(sheet) {
  const headers = [
    "Received At",
    "Client Name",
    "Client Email",
    "Client Phone Number",
    "Timeline",
    "Project Scope",
    "Install Location",
    "Budget Range",
    "Preferred Material Palette",
    "Specifications",
    "Reference Links",
    "Page",
    "User Agent"
  ];

  const firstRow = sheet.getRange(1, 1, 1, headers.length).getValues()[0];
  const isEmpty = firstRow.every(cell => !cell);
  if (isEmpty) sheet.getRange(1, 1, 1, headers.length).setValues([headers]);
}

function buildEmailHtml_(data, name, email) {
  const v = (k) => esc_(data[k]);

  const phone = v("phone");
  const timeline = v("timeline");
  const scope = v("scope");
  const location = v("location");
  const budget = v("budget");
  const materials = v("materials");

  const specs = (esc_(data.specs || "")).replace(/\n/g, "<br>");
  const links = (esc_(data.links || "")).replace(/\n/g, "<br>");
  const page = v("page");
  const userAgent = v("userAgent");

  // “Page formatting” style, but email-safe: inline styles, no Tailwind classes.
  return `
  <div style="margin:0;padding:24px;background:#121212;">
    <div style="
      max-width:720px;
      margin:0 auto;
      border:1px solid rgba(255,107,53,0.20);
      background:rgba(26,15,10,0.60);
      border-radius:18px;
      overflow:hidden;
      box-shadow:0 24px 80px rgba(0,0,0,0.60);
      font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, 'Liberation Mono', 'Courier New', monospace;
      color:#e8e0dc;
    ">
      <div style="padding:18px 20px;border-bottom:1px solid rgba(255,107,53,0.14);">
        <div style="font-size:11px;letter-spacing:0.34em;text-transform:uppercase;color:#d35400;opacity:0.9;">
          Commission Intake
        </div>
        <div style="margin-top:8px;font-family: Arial, sans-serif; font-weight:800; letter-spacing:0.06em; text-transform:uppercase; font-size:28px; line-height:1.1; color:#ff6b35;">
          New Request
        </div>
      </div>

      <div style="padding:18px 20px;">
        <table role="presentation" style="width:100%;border-collapse:collapse;">
          ${row_("Name", esc_(name))}
          ${row_("Email", esc_(email))}
          ${row_("Phone", phone || "—")}
          ${row_("Timeline", timeline || "—")}
          ${row_("Scope", scope || "—")}
          ${row_("Location", location || "—")}
          ${row_("Budget", budget || "—")}
          ${row_("Materials", materials || "—")}
        </table>

        <div style="margin-top:16px;border-top:1px solid rgba(255,107,53,0.14);padding-top:16px;">
          ${block_("Specifications", specs || "—")}
          ${block_("Reference links", links || "—")}
        </div>

        <div style="margin-top:18px;border-top:1px solid rgba(255,107,53,0.14);padding-top:14px;color:#8a665c;font-size:11px;letter-spacing:0.06em;">
          <div><b style="color:#d35400;letter-spacing:0.20em;text-transform:uppercase;">Page:</b> <span style="color:#c8b8b0;">${page || "—"}</span></div>
          <div style="margin-top:6px;"><b style="color:#d35400;letter-spacing:0.20em;text-transform:uppercase;">User Agent:</b> <span style="color:#c8b8b0;">${userAgent || "—"}</span></div>
          <div style="margin-top:6px;"><b style="color:#d35400;letter-spacing:0.20em;text-transform:uppercase;">Received:</b> <span style="color:#c8b8b0;">${esc_(new Date().toString())}</span></div>
        </div>
      </div>
    </div>
  </div>
  `;
}

function row_(label, value) {
  return `
    <tr>
      <td style="vertical-align:top;padding:10px 0;width:160px;">
        <div style="font-size:11px;letter-spacing:0.28em;text-transform:uppercase;color:#d35400;opacity:0.9;">
          ${esc_(label)}
        </div>
      </td>
      <td style="vertical-align:top;padding:10px 0;">
        <div style="font-size:14px;line-height:1.6;color:#e8e0dc;">
          ${value}
        </div>
      </td>
    </tr>
  `;
}

function block_(label, htmlValue) {
  return `
    <div style="margin-top:14px;">
      <div style="font-size:11px;letter-spacing:0.28em;text-transform:uppercase;color:#d35400;opacity:0.9;margin-bottom:8px;">
        ${esc_(label)}
      </div>
      <div style="font-size:14px;line-height:1.7;color:#c8b8b0;">
        ${htmlValue}
      </div>
    </div>
  `;
}

function esc_(v) {
  return (v == null ? "" : String(v))
    .replace(/&/g, "&amp;")
    .replace(/</g, "&lt;")
    .replace(/>/g, "&gt;")
    .replace(/"/g, "&quot;")
    .replace(/'/g, "&#39;");
}

function text_(s) {
  return ContentService
    .createTextOutput(String(s))
    .setMimeType(ContentService.MimeType.TEXT);
}
