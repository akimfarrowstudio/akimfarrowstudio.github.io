<script>
  const lb = document.getElementById("lb") || document.getElementById("scmLightbox");
  const lbClose = document.getElementById("lbClose") || document.getElementById("scmClose");
  const lbPrev = document.getElementById("lbPrev") || document.getElementById("scmPrev");
  const lbNext = document.getElementById("lbNext") || document.getElementById("scmNext");
  const lbImg = document.getElementById("lbImg") || document.getElementById("scmImg");
  const lbCapTitle = document.getElementById("lbCapTitle") || document.getElementById("scmCapTitle");
  const lbCapMeta = document.getElementById("lbCapMeta") || document.getElementById("scmCapMeta");

  const photoImgs = Array.from(document.querySelectorAll(".detail-frame.is-photo img"));

  const slides = photoImgs.map((img) => ({
    src: img.getAttribute("src"),
    alt: img.getAttribute("alt") || "",
    title: img.getAttribute("data-lb-title") || "Mokume-gane Rings",
    meta: img.getAttribute("data-lb-meta") || ""
  }));

  let idx = 0;

  function render() {
    if (!slides.length) return;

    const s = slides[idx];
    lbImg.src = s.src;
    lbImg.alt = s.alt;
    lbCapTitle.textContent = s.title;
    lbCapMeta.textContent = s.meta;

    const single = slides.length <= 1;
    if (lbPrev) lbPrev.disabled = single;
    if (lbNext) lbNext.disabled = single;
  }

  function openLB(startIndex) {
    if (!slides.length) return;
    idx = Math.max(0, Math.min(startIndex, slides.length - 1));
    render();
    lb.classList.add("open");
    lb.setAttribute("aria-hidden", "false");
    document.body.style.overflow = "hidden";
  }

  function closeLB() {
    lb.classList.remove("open");
    lb.setAttribute("aria-hidden", "true");
    document.body.style.overflow = "";
  }

  function prev() {
    if (slides.length <= 1) return;
    idx = (idx - 1 + slides.length) % slides.length;
    render();
  }

  function next() {
    if (slides.length <= 1) return;
    idx = (idx + 1) % slides.length;
    render();
  }

  // Open on click: bind indexes automatically
  document.querySelectorAll(".detail-frame.is-photo").forEach((frame, i) => {
    frame.addEventListener("click", () => openLB(i));
  });

  if (lbClose) lbClose.addEventListener("click", closeLB);
  if (lbPrev) lbPrev.addEventListener("click", prev);
  if (lbNext) lbNext.addEventListener("click", next);

  if (lb) {
    lb.addEventListener("click", (e) => {
      if (e.target === lb) closeLB();
    });
  }

  window.addEventListener("keydown", (e) => {
    if (!lb.classList.contains("open")) return;
    if (e.key === "Escape") closeLB();
    if (e.key === "ArrowLeft") prev();
    if (e.key === "ArrowRight") next();
  });

  // Console helper: tells you exactly which image path fails
  slides.forEach((s) => {
    const test = new Image();
    test.onload = () => {};
    test.onerror = () => console.warn("Image failed to load:", s.src, "(check folder + exact filename case)");
    test.src = s.src;
  });
</script>
